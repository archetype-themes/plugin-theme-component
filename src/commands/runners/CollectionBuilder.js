// Node imports
import { mkdir, rm } from 'node:fs/promises'
import { join } from 'node:path'

// Internal Imports
import BuildFactory from '../../factory/BuildFactory.js'
import Session from '../../models/static/Session.js'
import LocalesProcessor from '../../processors/LocalesProcessor.js'
import { validateExternalLocation } from '../../utils/ExternalComponentUtils.js'
import FileUtils from '../../utils/FileUtils.js'
import { exitWithError } from '../../utils/NodeUtils.js'
import WebUtils from '../../utils/WebUtils.js'
import JavaScriptProcessor from '../../processors/JavaScriptProcessor.js'
import LocaleUtils from '../../utils/LocaleUtils.js'
import StylesProcessor from '../../processors/StylesProcessor.js'
import Timer from '../../models/Timer.js'
import { logChildItem, WARN_LOG_LEVEL } from '../../utils/Logger.js'

class CollectionBuilder {
  /**
   * Build Collection
   * @param {module:models/Collection} collection
   * @return {Promise<module:models/Collection>}
   */
  static async build (collection) {
    const allComponents = collection.allComponents

    const buildCollectionTimer = new Timer()
    collection.build = BuildFactory.fromCollection(collection)
    await this.#resetBuildFolders(collection.build)
    logChildItem(`Collection Build Initialized (${buildCollectionTimer.now()} seconds)`);

    [collection.importMapEntries, collection.build.locales, collection.build.styles] = await Promise.all([
      this.#buildJavaScript(allComponents, collection.build.importMapFile, collection.rootFolder),
      this.#buildLocales(allComponents, collection.rootFolder),
      this.#buildStyles(allComponents, collection.build.stylesheet, collection.rootFolder)
    ])

    return collection
  }

  /**
   * Builds JavaScript files for the given collection and components.
   *
   * @param {(Component|Snippet)[]} components - An array of all components.
   * @param {string} importMapFile - The collection's import map file.
   * @param {string} cwd - The working directory.
   * @return {Promise<Map<string, string>>} - A promise that resolves when the JavaScript files have been built.
   */
  static async #buildJavaScript (components, importMapFile, cwd) {
    const jsFiles = this.#getJsFiles(components)

    if (jsFiles.length) {
      logChildItem('Starting Import Map Processor')
      const timer = new Timer()
      const importMapEntries = await JavaScriptProcessor.buildJavaScript(jsFiles, importMapFile, cwd)
      logChildItem(`Completed Import Map Processor in ${timer.now()}seconds`)
      return importMapEntries
    } else {
      logChildItem('No Javascript Files Found. Javascript Build Process Was Skipped.', WARN_LOG_LEVEL)
    }
  }

  /**
   * Builds locales for the given collection and all components.
   *
   * @param {(Component|Snippet)[]} components - All components to extract liquid code from.
   * @param {string} cwd - The working directory.
   * @return {Promise<{}>} - A promise that resolves when the locales are built.
   */
  static async #buildLocales (components, cwd) {
    const liquidCodeElements = components.map(component => component.liquidCode)
    try {
      const validLocalesRepo = await validateExternalLocation(Session.localesRepo, cwd)
      return LocalesProcessor.build(liquidCodeElements, validLocalesRepo, cwd)
    } catch (error) {
      exitWithError('Source Locales DB Folder or Repository is invalid: ' + error.message)
    }
  }

  /**
   * Builds the styles for the given collection and all components.
   *
   * @param {(Component|Snippet)[]} components - An array containing all the components.
   * @param {string} outputFile - The collection's css bundle file.
   * @param {string} cwd - The working directory.
   * @return {Promise<string>} - A promise that resolves when the styles are built.
   */
  static async #buildStyles (components, outputFile, cwd) {
    const mainStylesheets = this.#getMainStylesheets(components)

    if (mainStylesheets.length) {
      return StylesProcessor.buildStylesBundle(mainStylesheets, outputFile, cwd)
    }
  }

  /**
   * Deploy Collection To Folder
   * @param {module:models/Collection} collection
   * @returns {Promise<Awaited<unknown>[]>}
   */
  static async deployToBuildFolder (collection) {
    const allComponents = collection.allComponents

    const localesWritePromise = LocaleUtils.writeLocales(collection.build.locales, collection.build.localesFolder)
    const snippetFilesWritePromises = allComponents.map(component =>
      FileUtils.saveFile(join(collection.build.snippetsFolder, `${component.name}.liquid`), component.build.liquidCode))

    const allAssetFiles = this.#getAssetFiles(allComponents)
    const copyAssetsPromise = FileUtils.copyFilesToFolder(allAssetFiles, collection.build.assetsFolder)

    const promises = [
      FileUtils.saveFile(collection.build.stylesheet, collection.build.styles),
      localesWritePromise,
      ...snippetFilesWritePromises,
      copyAssetsPromise
    ]

    if (collection.importMapEntries?.size) {
      promises.push(this.#deployImportMapFiles(collection.importMapEntries, collection.build.assetsFolder))
    }

    return Promise.all(promises)
  }

  /**
   * Deploy import map files to the assets folder
   * @param {Map<string, string>} buildEntries
   * @param {string} assetsFolder
   */
  static async #deployImportMapFiles (buildEntries, assetsFolder) {
    const localFiles = []
    const remoteFiles = []
    for (const [, modulePath] of buildEntries) {
      if (WebUtils.isUrl(modulePath)) {
        remoteFiles.push(modulePath)
      } else {
        localFiles.push(modulePath)
      }
    }
    return Promise.all([FileUtils.copyFilesToFolder(localFiles, assetsFolder), WebUtils.downloadFiles(remoteFiles, assetsFolder)])
  }

  /**
   * Retrieves asset files from an array of Component or Snippet objects.
   *
   * @param {(Component|Snippet)[]} components - An array of components or snippets.
   * @return {string[]} - An array of asset files.
   */
  static #getAssetFiles (components) {
    return components
      .filter(component => component.files.assetFiles?.length)
      .flatMap(component => component.files.assetFiles)
  }

  /**
   * Get Collection JavaScript Files
   * @param {(Component|Snippet)[]} components
   * @return {string[]}
   */
  static #getJsFiles (components) {
    return components
      .filter(component => component.files.javascriptIndex)
      .map(component => component.files.javascriptIndex)
  }

  /**
   * Get Main Stylesheets from all components and snippets
   * @param {(Component|Snippet)[]} components
   * @return {string[]}
   */
  static #getMainStylesheets (components) {
    return components
      .filter(component => component.files.mainStylesheet)
      .map(component => component.files.mainStylesheet)
  }

  /**
   * Reset Collection Build Folders
   * @param {CollectionBuild} build
   * @return {Promise<Awaited<unknown>[]>}
   */
  static async #resetBuildFolders (build) {
    await rm(build.rootFolder, { force: true, recursive: true })
    await mkdir(build.rootFolder, { recursive: true })

    const buildFolders = [
      build.assetsFolder,
      build.configFolder,
      build.localesFolder,
      build.sectionsFolder,
      build.snippetsFolder
    ]
    const mkdirPromises = buildFolders.map(buildFolder => mkdir(buildFolder, { recursive: true }))

    return Promise.all(mkdirPromises)
  }
}

export default CollectionBuilder
